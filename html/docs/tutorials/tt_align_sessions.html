<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" href="../../css/master.css">
    <meta charset="utf-8">
    <title>How to perform align imaging sessions</title>
  </head>
  <body>
    <h2>Align imaging recording sessions</h2>
    <hr>
    <p>
      Here, we show how to perform automatic and manual image registration in order to align different recording sessions from a given subject. This process is useful for longitudinal studies where different animals are imaged several times over the course of the experiment.
    </p>
    <p>
      In this example you will learn:
    </p>
    <ul>
      <li>How to create a reference frame for image registration.</li>
      <li>How to run automatic image registration over several recordings.</li>
      <li>How to perform manual image registration of a given recording session.</li>
    </ul>
    <p>
      The raw data consists of multi-channel (fluorescence and reflectance) recordings of an anesthetized mouse expressing GCaMP6 calcium indicator in cortical neurons. The data that we will align consists of four resting state recordings (see <a href="./tt_creating_connectivity_maps.html">this tutorial</a> to learn how to process resting state data) of one mouse acquired over a period of 2 months. Here is the processing workflow of this example:
    </p>
    <p align="center"><i>Recording alignment workflow</i></p>
    <p align="center">
      <img src="../assets/img/tt_align_recordings_workflow.png" alt="tt_align_recordings_workflow">
    </p>
    <h3>Sections</h3>
    <hr>
    <ul>
      <li><a href="#import-and-preprocess-data">Import and preprocess the data</a>: Import the raw data and perform the hemodynamic correction on the fluorescence signal.</li>
      <li><a href="#create-img-reference">Create the imaging reference frame</a>: use the <i>ROImanager</i> app to create the image to be used as reference for the alignment.</li>
      <li><a href="#automatic-alignment">Perform automatic alignment</a>: run automatic alignment over several recordings.</li>
      <li><a href="#manual-alignment">Perform manual alignment</a>: alternatively, perform a manual alignment of a given recording using Matlab's control point selection tool.</li>
    </ul>
    <div class="warnnote">
      <p><strong>Important</strong><br>
        The automatic and manual alignemnt tools are currently available <b>only</b> in the main GUI (<samp>umIToolbox</samp>)!
      </p>
    </div>

    <h3 id='import-and-preprocess-data'>Import and preprocess the data</h3>
    <hr>
    <p>
      Here, we assume that the project file was created. For more info on how to create a project file click <a href="/tt_creating_a_new_project.html">here</a>.
      To open a project file, call the <samp>umIToolbox</samp> app with the full path to your project file as input as:
    </p>
    <div class="codeinput">
      <pre>
        umIToolbox(<font class="stringformat">'C:/FOLDER/projectfile.mat'</font>);
      </pre>
    </div>

    <p>
      In the main GUI, go to the <i>Pipeline control panel tab</i> and select the recordings to be processed (steps 1 and 2) and launch the <i>Pipeline Configuration</i> app (step 3). Here, we will align all four recordings from the mouse <b>M4D</b>:
    </p>
    <img src="../assets/img/align_tt_selectdata.png" alt="align_tt_selectdata", width = "660">
    <p>
      Select the <i>FluorescenceImaging</i> object from the list of available objects:
    </p>
    <img src="../assets/img/align_tt_select_objtype.png" alt="align_tt_select_objtype", width = "220">
    <p>
      In the <i>Pipeline Configuration</i> app, add the data import function <samp>run_ImagesClassification</samp> and the hemodynamic correction function <samp>run_HemoCorrection</samp>. In this case, we will use the default parameters from both of them. Finally, click on the green button "Save Config" to finish creating the pipeline:
    </p>
    <img src="../assets/img/align_tt_dataimport_ppline.png" alt="align_tt_dataimport_ppline", width = "660">
    <p>
      Back in the main GUI, click on <i>Run Pipeline</i> to import the raw data from the selected recordings. Once the data import is finished, we move on to the creation of the reference frame.
    </p>
    <h3 id='create-img-reference'>Create the imaging reference frame</h3>
    <hr>
    <p>
      In the previous section, we imported the fluorescence and reflectance data, and used the latter to separate the hemodynamic signal from the fluorescence one. The corrected fluorescence data is stored in the file <samp>hemoCorr_fluo.dat</samp>. Now, we will choose one of the four recordings to create the reference frame for the alignment.
    </p>
    <div class="tipnote">
      <p><strong>Tip</strong><br>
        Any channel (fluorescence or any of the reflectance channels) can be used as reference frame for the alignment process. However, the automatic alignment algorithm works better with images having a good contrast between the brain tissue and the blood vessels such as the green(reflectance) and fluorescence channels. In the present case, we will use the <i>fluorescence</i> channel to create the reference frame.
      </p>
    </div>
    <p>
      In the main GUI, go to the <i>Visualization</i> tab and select the recording to be the reference. In our case, we selected the recording <b>RS_21ST1803</b> to be the reference. Then, in the <i>Select a file</i> list box, click on the <samp>fluo.dat</samp> file. The reference frame is created using the <i>ROImanager</i> app. Click on the app's button to open it:
    </p>
    <img src="../assets/img/align_tt_refFrame_dataselect.png" alt="align_tt_refFrame_dataselect", width = "660">
    <p>
      Below is a snapshot of the <i>ROImanager</i> interface with a sample frame of the fluorescence data file <samp>fluo.dat</samp>:
    </p>
    <img src="../assets/img/align_tt_roimanager_fig1.png" alt="align_tt_roimanager_fig1", width = "660">
    <div class="infonote">
      <p><strong>Note</strong><br>
        The <i>Imaging Reference Frame</i> file carries more than a simple image frame used for alignment. For instance, one can use this file to store information such as the image's pixel ratio (in px/mm), the coordinantes of a reference point (e.g. in mice, generally the <i>Bregma</i> is used as reference point). In addition, one can also create and store a logical mask used in other analysis functions when one needs to exclude pixels that lie outside the brain. In this example, we will go through the steps to create and store the abovementioned information in our <i>Imaging Reference Frame</i> file.
      </p>
      <p>
        Creating an image reference frame for alignment is only one of the features of the <i>ROImanager</i> app. For more in-depth information on the app, check it's documentation <a href="#">here</a>!
      </p>
    </div>
    <p>Here are the next steps that will be performed to create the <i>Imaging Reference Frame</i> file:</p>
    <ol>
      <li>Set the reference point.</li>
      <li>Align image to the reference point.</li>
      <li>Set the pixel ratio.</li>
      <li>Create a logical mask.</li>
      <li>Export the data to the <i>Imaging Reference Frame</i> file</li>
    </ol>
    <h4>1. Set the reference Point</h4>
    <p>
      To draw a new reference point, go to <i>Image >> Set origin >> New</i>. Follow the instructions to select the point. Here, we selected the Bregma as our reference point:
    </p>
    <img src="../assets/img/align_tt_refpt_selected.png" alt="align_tt_refpt_selected", width = "660">
    <h4>2. Align image to the reference point</h4>
    <p>
      Now, notice that the mouse's cortical surface is not properly aligned (it is slightly rotated to the right). To fix this go to <i>Image >> Set origin >> Align image to origin</i>. Click the highlighted point and place it over a point where it should be vertically aligned with the reference point:
    </p>
    <img src="../assets/img/align_tt_click_and_drag_pt.png" alt="align_tt_click_and_drag_pt", width = "660">
    <p>
      Right-click over the point to and confirm the image rotation. Below we can see the rotated frame:
    </p>
    <img src="../assets/img/align_tt_result_refpt_alignment.png" alt="align_tt_result_refpt_alignment", width = "800">
    <h4>3. Set the pixel ratio</h4>
    <p>
      To set the pixel ratio, go to <i>Image >> Set pixel size</i>. In the dialog box, type the pixel ratio:
    </p>
    <img src="../assets/img/align_tt_set_px_size.png" alt="align_tt_set_px_size">
    <p>
      When the pixel size is set, the axis is automatically rescaled to millimeters:
    </p>
    <img src="../assets/img/align_tt_px_size_set.png" alt="align_tt_px_size_set">
    <div class="infonote">
      <p><strong>Note</strong><br>
      The pixel ratio is not strictly essential to perform the alignment ot to run the currently available analysis functions. However, if you have this information, it is a good practice to include it in the <i>Imaging Reference Frame</i> file.
    </p>
    </div>
    <h4>4. Create a logical mask</h4>
    <p>
      A logical mask can be created when there are regions of the image that you want to exclude in the analysis. For instance, in our case, the periphery of the image consists of pixels that lie outside the mouse cortex. Thus, we can draw a mask to delimit the cortex and exclude everything else.
    </p>
    <div class="infonote">
      <p><strong>Note</strong><br>
        Please, note that the logical mask creation and use is not a destructive process. This means that the imaging data is not deleted or transformed when the mask is created. Instead, the mask is used by some analysis functions to indicate which pixels will be considered in the analysis.
      </p>
    </div>
    <p>
      To draw a new logical mask go to <i>Image >> Mask >> Draw new</i>. You can set up to 10 regions as a mask. In our case, we will create one region delimiting the visible cortex:
    </p>
    <img src="../assets/img/align_tt_draw_logicmsk.png" alt="align_tt_draw_logicmsk", width = "660">
    <p>
      Once finished drawing the region, double-click inside it to save. The saved mask will appear as a highlighted region over the image:
    </p>
    <img src="../assets/img/align_tt_final_logicmsk.png" alt="align_tt_final_logicmsk", width = "660">
    <h4>5. Export the data to the <i>Imaging Reference Frame</i> file</h4>
    <p>
      Now that the frame was aligned, all it's information was set and the logical mask was created, we can save everything to the <i>Imaging Reference Frame </i>file. To do so, go to <i>Image >> Image Reference file... >> Export</i>. A file named <samp>ImagingReferenceFrame.mat</samp> will be automatically created in the subject's save folder:
    </p>
    <img src="../assets/img/align_tt_refFrameFile_saved.png" alt="align_tt_refFrameFile_saved.png">
    
    <h3 id="automatic-alignment">Perform automatic alignment</h3>
    <hr>
    <p>

    </p>















  </body>
</html>
