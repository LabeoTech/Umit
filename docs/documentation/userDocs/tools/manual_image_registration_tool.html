---
permalink: /documentation/userDocs/tools/manual_image_registration_tool.html
layout: default
title: Manual image registration
parent: Tools
grand_parent: Documentation
nav_order: 4
---
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">    
    <style media="screen">
      ul {
        line-height: 1.5;
      }
    </style>
    <title>Manual image registration</title>
  </head>
  <body>
  <h2>Manual image registration tool</h2>
    <hr>
    <p>
      The manual image registration tool is available from the <i>Visualization</i> tab of the <b><i>umIToolbox</i></b> app. This tool uses landmarks to align a recording to a reference frame. The landmark selection is performed interactively using Matlab's control-point selection tool <a href="https://www.mathworks.com/help/images/ref/cpselect.html?searchHighlight=cpselect&s_tid=srchtitle_cpselect_1"><samp>cpselect</samp></a>. Then, the geometric transformations used to fit the points to the reference frame is applied to the target imaging file.
    </p>
    <h3 id="the-algorithm">The alignment algorithm</h3>
    <hr>
    <p>
      The geometric transformations performed by our image registration algorithm are: <i>translation</i>, <i>rotation</i> and <i>scaling</i>. Other transformations such as reflection or shearing are not applied.
    </p>
    <p style="text-align: center;">
      <img src="../../assets/img/align_tt_geomtransf.png" alt="align_tt_geomtransf" width = "660"><br>
      <i>Geometric transformations applied in our image registration algorithm</i>
    </p>
    <h3 id="procedure">Procedure</h3>
    <hr>
    <p>
      First of all, open you project file in <a href="../apps/umIToolbox.html"><samp>umIToolbox</samp></a> app and go to the <i>Visualization tab</i>. Here, we assume that a reference frame file was created and saved in the subject's folder. For instructions on how to create a reference frame, read the documentation of the <a href="../apps/ROImanager.html"><samp>ROImanager</samp></a> app.
    </p>
    <p>
      Here are the steps to manually align an imaging recording to a reference frame:
    </p>
    <ol>
      <li><a href="#1-select-input-file">Select input file</a></li>
      <li><a href="#2-choose-landmarks">Choose landmarks</a></li>
      <li><a href="#3-validate-registration">Validate and apply the registration to a file</a></li>
    </ol>
    <h4 id="1-select-input-file">1. Select input file</h4>
    <p>
      To select a file to align with the reference frame, click on the item in the object tree containig the recording (1), select the file from the <i>file list</i> (2) and launch the <i>Manual image registration tool</i> (3):
    </p>
    <p style="text-align: center;">
      <img src="../../assets/img/manual_image_registration_tool_fig1.png" alt="manual_image_registration_tool_fig1" width="660"><br>
      <i>Step 1: select the file to align and launch the Manual image registration tool.</i>
    </p>
    <p>
      Then, type the name of the Imaging reference frame file:
    </p>
    <p style="text-align: center;">
      <img src="../../assets/img/manual_image_registration_tool_type_imaging_reference_frame_filename.png" alt="manual_image_registration_tool_type_imaging_reference_frame_filename" width="260">
    </p>
    <div class="warnnote">
      <p><strong>Important</strong><br>
        The <i>Imaging reference frame file</i> <b>must</b> be stored in the subject's folder!
      </p>
    </div>
    <h4 id="2-choose-landmarks">2. Choose landmarks</h4>
    <p>
      The <i>Manual image registration tool</i> will load the reference frame from the <samp>ImagingReferenceFrame.mat</samp> and a <i>target frame</i>. The target frame is automatically extracted from an imaging file similar to the one used to create the <i>reference frame</i>. For instance, if you used the data stored in the file <samp>green.dat</samp> to create the <i>reference frame</i> the tool will extract a frame (<i>target frame</i>) from the <samp>green.dat</samp> file located in the same folder as the input file (i.e. the file that you want to align).
    </p>
    <div class="infonote">
      <p><strong>Note</strong><br>
        If the file containing the <i>target frame</i> is not found in the recording's folder, a dialog box will appear so you can choose a file to be used to register with the <i>reference frame</i>!
      </p>
    </div>
    <p>
      Now, the <i>reference</i> and <i>target</i> frames will be loaded in the <a href="https://www.mathworks.com/help/images/ref/cpselect.html?searchHighlight=cpselect&s_tid=srchtitle_cpselect_1"><samp>cpselect</samp></a> interface to choose the landmarks (control-points). Both frames are spatially filtered to highlight the images' landmarks such as blood vessels and bone sutures. The target and reference frames are shown in the left and righthand sides of the interface respectively. Use the top (zoomed) axes to create the control points.
    </p>
    <p>
      To create the control points, click on the landmarks in both images <b>sequentially</b>. You can click and drag the individual control points to perform adjustments.
    </p>
    <div class="tipnote">
      <p><strong>Tip</strong><br>
        For better results, use at least <b>3</b> control points covering as much surface as possible on the image.
      </p>
    </div>
    <p style="text-align: center;">
      <video src="../../assets/gifs/manual_image_registration_cpselection.ogg" alt="manual_image_registration_cpselection" width="880" controls></video><br>
      <i>Step 2. Select the landmarks on both the reference frame (right) and the target frame (left).</i>
    </p>
    <p>Finally, close the window when you are done.</p>
    <h4 id="3-validate-registration">Validate and apply the registration to a file</h4>
    <p>
      Once the <samp>cpselect</samp> interface is closed, the tool will perform the registration of the target frame to the reference frame. A figure will appear showing the result of the registration. The image on the top shows a pseudo-colored overlay of the reference (bottom left) and the registered frame (bottom right). To help you with the visual inspection of the registration, you can use the mouse cursor to hover over any of the images and see the respective points in the others.
    </p>
    <p style="text-align: center;">
      <video src="../../assets/gifs/manual_image_registration_validation.ogg" alt="manual_image_registration_validation" width="660" controls></video><br>
      <i>Step 3. Validation of the registration process by visual inspection.</i>
    </p>
    <p>
      Now, close the figure to continue. A dialog box will open with options:
    </p>
    <img src="../../assets/img/manual_image_registration_tool_confirm_registration.png" alt="manual_image_registration_tool_confirm_registration" width="300">
    <p>
      To apply the registration to the <i>input file</i>, click on <i>Yes, proceed</i>. If the registration was unsuccessful, you can redo the control point selection by clicking on <i>No, redo</i>.
    </p>
    <p>
      Once confirmed, type the name of the new file with the aligned data and click <i>Ok</i>:
    </p>
    <img src="../../assets/img/manual_image_registration_tool_output_filename.png" alt="manual_image_registration_tool_output_filename" width="200">
    <p>Now, the geometric transformations will be applied to each frame of the <i>input file</i> and saved to a <samp>.dat</samp> file in the object's save folder.</p>
    <hr>
  </body>
</html>